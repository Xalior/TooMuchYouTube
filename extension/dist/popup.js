(()=>{var s=document.getElementById("rulesBody"),p=document.getElementById("status"),G=document.getElementById("addRule"),y=document.getElementById("quickAddChannel"),v=document.getElementById("quickAddVideo"),D=document.getElementById("newType"),T=document.getElementById("newValue"),g=document.getElementById("newSpeed"),H=document.getElementById("debugInfo"),X=document.getElementById("aboutOpen"),K=document.getElementById("aboutOpenBottom"),_=document.getElementById("appLogo"),F=document.getElementById("aboutPanel"),J=document.getElementById("aboutBuildMode"),P=document.getElementById("editor"),Q=document.getElementById("notYoutube");if(!s||!p||!G||!y||!v||!D||!T||!g||!H||!X||!K||!_||!F||!J||!P||!Q)console.warn("TooMuchYouTube popup: missing required elements.");else{let V=function(e){let t=e.map(l=>l.trim()).filter(Boolean),n=t.find(l=>l.startsWith("@"));if(n)return n;let o=t.find(l=>/^UC[\w-]{10,}$/.test(l));return o||t[0]||""},A=function(){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},t=>{e(t&&t[0]?t[0]:null)})})},w=function(e){return new Promise(t=>{chrome.tabs.sendMessage(e,{type:"getQuickAddData"},n=>{if(chrome.runtime.lastError){t(null);return}t(n||null)})})},R=function(e){Y=e,P.classList.toggle("hidden",!e),Q.classList.toggle("hidden",e),document.body.classList.toggle("not-youtube",!e)},k=function(e){document.body.classList.toggle("about-open",e),F.classList.toggle("hidden",!e),e?(P.classList.remove("hidden"),Q.classList.add("hidden")):R(Y)},z=function(){chrome.tabs?.query&&chrome.tabs.query({active:!0,currentWindow:!0},e=>{let t=e&&e[0]?e[0]:null;if(!t?.id){R(!1);return}w(t.id).then(n=>{R(!!n)})})},i=function(e,t="success"){p.textContent=e,p.classList.remove("success","error","warning"),e?p.classList.add("show",t):p.classList.remove("show"),e&&(C&&window.clearTimeout(C),C=window.setTimeout(()=>{p.textContent="",p.classList.remove("show")},1500))},te=function(){document.body.classList.toggle("is-debug",m),H.classList.toggle("hidden",!m);let e=document.querySelector(".bottom-bar");e instanceof HTMLElement&&e.classList.toggle("no-debug",!m),x?_.classList.toggle("debug-rotated",m):_.classList.remove("debug-rotated"),m?H.textContent="DEBUG 0a5ce78.260124.191924":H.textContent=""},N=function(e,t){m=e,te(),t&&chrome.storage.local.set({[S]:m})},W=function(){if(!x){N(!0,!1);return}chrome.storage.local.get({[S]:!1},e=>{N(!!e[S],!1)})},ne=function(){J.textContent="prod"},oe=function(e){let t=le(d);chrome.storage.sync.set({rules:t},()=>{d=t,E(),e&&i("Saved","success")})},M=function(e=!0){I&&window.clearTimeout(I),I=window.setTimeout(()=>{I=null,oe(e)},500)},E=function(){if(s.innerHTML="",d.length===0){let e=document.createElement("div");e.className="hint",e.textContent="No rules yet. Add one below.",s.appendChild(e);return}d.forEach((e,t)=>{let n=document.createElement("div");n.className="row",n.dataset.index=String(t);let o=document.createElement("div");o.className="order";let l=document.createElement("span");l.className="index",l.textContent=String(t+1);let u=document.createElement("button");u.type="button",u.className="icon-btn small drag-handle",u.textContent="\u2261",u.title="Drag to reorder",u.draggable=!1,o.append(l,u);let U=document.createElement("select");U.dataset.field="type",["channel","videoId","title"].forEach(O=>{let B=document.createElement("option");B.value=O,B.textContent=ee[O],e.type===O&&(B.selected=!0),U.appendChild(B)});let L=document.createElement("input");L.type="text",L.value=e.value,L.placeholder="Match text",L.dataset.field="value";let f=document.createElement("input");f.type="number",f.min="0.25",f.max="4",f.step="0.25",f.value=e.speed,f.placeholder="1.5",f.dataset.field="speed";let q=document.createElement("div");q.className="actions-inline";let h=document.createElement("button");h.type="button",h.className="icon-btn danger",h.textContent="Delete",h.dataset.action="delete",q.append(h),n.append(o,U,L,f,q),s.appendChild(n)})},le=function(e){return e.map(t=>({id:t.id||crypto.randomUUID(),type:t.type,value:String(t.value||"").trim(),speed:String(t.speed||"").trim()})).filter(t=>t.value&&t.speed)},ae=function(e,t){if(t<0||t>=d.length)return;let n=[...d],[o]=n.splice(e,1);n.splice(t,0,o),d=n,E(),M()},se=function(e){d=d.filter((t,n)=>n!==e),E(),M(!1),i("Deleted","error")},de=function(e,t,n){d=d.map((o,l)=>l!==e?o:{...o,[t]:n}),M()},re=function(e){return e.closest(".drag-handle")?!1:!!e.closest("input, select, textarea, button")},ie=function(e,t){b=Number(e.dataset.index),c=t,r=e,a=r.cloneNode(!0),a.classList.add("drag-placeholder"),a.removeAttribute("data-index"),a.setAttribute("aria-hidden","true"),r.style.display="none",s.insertBefore(a,r),document.body.classList.add("no-select")},ue=function(e,t){if(!a)return;let n=Array.from(s.querySelectorAll(".row")).filter(l=>l!==a&&l!==r);if(n.length===0){s.appendChild(a);return}let o=n.find(l=>{let u=l.getBoundingClientRect();return t<u.top+u.height/2});o?o.insertAdjacentElement("beforebegin",a):n[n.length-1].insertAdjacentElement("afterend",a)},ce=function(e){let t=s.getBoundingClientRect(),n=24,o=12;if(e<t.top+n){let l=Math.max(0,t.top+n-e);s.scrollTop-=Math.min(o,l);return}if(e>t.bottom-n){let l=Math.max(0,e-(t.bottom-n));s.scrollTop+=Math.min(o,l)}},me=function(){if(b!==null){if(a){let e=Array.from(s.children),t=0;for(let n of e){if(n===a)break;n.classList.contains("row")&&n!==r&&n!==a&&(t+=1)}b!==t&&ae(b,t)}j()}},j=function(){a&&a.parentElement&&a.parentElement.removeChild(a),r&&(r.style.display=""),b=null,a=null,r=null,c=null,document.body.classList.remove("no-select")},Z={rules:[]},ee={channel:"Channel",title:"Title",videoId:"Video ID"},d=[],b=null,a=null,r=null,c=null,I=null,C=null,Y=!0,m=!1,x=!0,S="debugEnabled";async function $(){let t=(await A())?.id;if(!t){y.disabled=!0,v.disabled=!0;return}let n=await w(t);if(!n){y.disabled=!0,v.disabled=!0;return}let o=n.videoId,l=V(n?.channelCandidates||[]);v.disabled=!o,y.disabled=!l}s.addEventListener("click",e=>{let t=e.target;if(!(t instanceof HTMLElement))return;let n=t.closest(".row");if(!(n instanceof HTMLElement))return;let o=Number(n.dataset.index);t.dataset.action==="delete"&&se(o)}),s.addEventListener("pointerdown",e=>{if(e.button!==0)return;let t=e.target;if(!(t instanceof HTMLElement)||re(t))return;let n=t.closest(".row");n instanceof HTMLDivElement&&(ie(n,e.pointerId),e.target.setPointerCapture(e.pointerId))}),s.addEventListener("pointermove",e=>{c===null||e.pointerId!==c||(ce(e.clientY),ue(e.clientX,e.clientY))}),s.addEventListener("pointerup",e=>{c===null||e.pointerId!==c||me()}),s.addEventListener("pointercancel",e=>{c===null||e.pointerId!==c||j()}),s.addEventListener("input",e=>{let t=e.target;if(!(t instanceof HTMLInputElement||t instanceof HTMLSelectElement))return;let n=t.closest(".row");if(!(n instanceof HTMLElement))return;let o=Number(n.dataset.index),l=t.dataset.field;l&&de(o,l,t.value)}),G.addEventListener("click",()=>{let e=T.value.trim(),t=g.value.trim();if(!e||!t){i("Add a match and speed","warning");return}d=[...d,{id:crypto.randomUUID(),type:D.value,value:e,speed:t}],T.value="",g.value="",E(),M()}),X.addEventListener("click",()=>{k(!document.body.classList.contains("about-open"))}),K.addEventListener("click",()=>{k(!document.body.classList.contains("about-open"))}),_.addEventListener("click",e=>{x&&e.detail===3&&N(!m,!0)}),y.addEventListener("click",async()=>{let t=(await A())?.id;if(!t){i("Open a YouTube tab","warning");return}let n=await w(t);if(!n){i("Open a YouTube tab","warning");return}let o=V(n?.channelCandidates||[]);if(!o){i("Channel not found","error");return}D.value="channel",T.value=o,g.focus(),g.select()}),v.addEventListener("click",async()=>{let t=(await A())?.id;if(!t){i("Open a YouTube tab","warning");return}let n=await w(t);if(!n){i("Open a YouTube tab","warning");return}let o=n.videoId;if(!o){i("Video ID not found","error");return}D.value="videoId",T.value=o,g.focus(),g.select()}),chrome.storage.sync.get(Z,e=>{d=e.rules||[],E(),z(),$(),W(),ne(),k(!1)}),z(),$(),W()}})();
